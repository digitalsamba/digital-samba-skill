name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create skill zip
        run: |
          # Extract version from tag (e.g., v1.0.2 -> 1.0.2)
          VERSION=${GITHUB_REF_NAME#v}
          echo "Version: $VERSION"

          # Update VERSION file to match release tag
          echo "$VERSION" > VERSION

          # Skill files are now at repo root - zip them directly
          # Claude Desktop requires SKILL.md at root level of ZIP
          zip digital-samba.zip SKILL.md api-reference.md sdk-reference.md patterns.md jwt-tokens.md VERSION
          echo "Created digital-samba.zip"
          unzip -l digital-samba.zip

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Extracting changelog for version $VERSION"

          # Extract section between this version header and the next version header
          # Use awk to capture everything between ## [VERSION] and the next ## [
          NOTES=$(awk "/^## \[$VERSION\]/{found=1; next} /^## \[/{found=0} found" CHANGELOG.md)

          # If no notes found, use a default message
          if [ -z "$NOTES" ]; then
            NOTES="See [CHANGELOG.md](https://github.com/digitalsamba/digital-samba-skill/blob/main/CHANGELOG.md) for details."
          fi

          # Write to file for the release body (handles multiline)
          echo "$NOTES" > release_notes.md

          # Append install link
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "ðŸ“¦ **Install:** See [README](https://github.com/digitalsamba/digital-samba-skill#installation) for installation options." >> release_notes.md

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: digital-samba.zip
          body_path: release_notes.md
