name: Check for API/SDK Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check OpenAPI spec for changes
        id: api-check
        run: |
          curl -s https://developer.digitalsamba.com/rest-api/openapi.yaml -o openapi-new.yaml

          if ! diff -q openapi-stored.yaml openapi-new.yaml > /dev/null 2>&1; then
            echo "api_changed=true" >> $GITHUB_OUTPUT
            echo "API spec has changed"
          else
            echo "api_changed=false" >> $GITHUB_OUTPUT
            echo "API spec unchanged"
          fi

      - name: Check SDK version for changes
        id: sdk-check
        run: |
          STORED_VERSION=$(cat .sdk-version | tr -d '\n')
          LATEST_VERSION=$(npm view @digitalsamba/embedded-sdk version)

          echo "Stored: $STORED_VERSION"
          echo "Latest: $LATEST_VERSION"

          if [ "$STORED_VERSION" != "$LATEST_VERSION" ]; then
            echo "sdk_changed=true" >> $GITHUB_OUTPUT
            echo "old_version=$STORED_VERSION" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "SDK version changed: $STORED_VERSION -> $LATEST_VERSION"
          else
            echo "sdk_changed=false" >> $GITHUB_OUTPUT
            echo "SDK version unchanged"
          fi

      - name: Create issue for API changes
        if: steps.api-check.outputs.api_changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING=$(gh issue list --label "api-update" --state open --json number --jq 'length')
          if [ "$EXISTING" -gt 0 ]; then
            echo "API update issue already exists"
            exit 0
          fi

          DATE=$(date +%Y-%m-%d)
          cat << 'ISSUE_BODY' > /tmp/issue-body.md
          The Digital Samba OpenAPI specification has changed.

          ## Next Steps

          1. Start a Claude Code session in this repo
          2. Run `/session-start`
          3. Ask Claude to analyze the API changes and update the skill

          ## Quick Command

          ```
          Compare openapi-stored.yaml with the current spec at https://developer.digitalsamba.com/rest-api/openapi.yaml

          Identify:
          - New endpoints
          - Changed parameters
          - Removed endpoints (flag for review)

          Update api-reference.md accordingly.
          ```
          ISSUE_BODY
          echo "" >> /tmp/issue-body.md
          echo "---" >> /tmp/issue-body.md
          echo "*Detected by automated check on ${DATE}*" >> /tmp/issue-body.md

          gh issue create \
            --title "API Update Detected" \
            --label "api-update" \
            --label "needs-review" \
            --body-file /tmp/issue-body.md

      - name: Create issue for SDK changes
        if: steps.sdk-check.outputs.sdk_changed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          OLD_VERSION: ${{ steps.sdk-check.outputs.old_version }}
          NEW_VERSION: ${{ steps.sdk-check.outputs.new_version }}
        run: |
          EXISTING=$(gh issue list --label "sdk-update" --state open --json number --jq 'length')
          if [ "$EXISTING" -gt 0 ]; then
            echo "SDK update issue already exists"
            exit 0
          fi

          DATE=$(date +%Y-%m-%d)
          cat << ISSUE_BODY > /tmp/issue-body.md
          The Digital Samba Embedded SDK has been updated.

          ## Version Change

          - **Previous**: ${OLD_VERSION}
          - **Latest**: ${NEW_VERSION}

          ## Resources

          - [NPM Package](https://www.npmjs.com/package/@digitalsamba/embedded-sdk)
          - [SDK GitHub](https://github.com/digitalsamba/embedded-sdk)
          - [SDK Docs](https://docs.digitalsamba.com/reference/sdk)

          ## Next Steps

          1. Start a Claude Code session in this repo
          2. Run \`/session-start\`
          3. Ask Claude to check for new methods/events and update sdk-reference.md

          ---
          *Detected by automated check on ${DATE}*
          ISSUE_BODY

          gh issue create \
            --title "SDK Update Detected: ${OLD_VERSION} to ${NEW_VERSION}" \
            --label "sdk-update" \
            --label "needs-review" \
            --body-file /tmp/issue-body.md
